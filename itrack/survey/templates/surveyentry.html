{% extends "base_generic.html" %}

{% block content %}
{# block title %}Users Surveys Entery{% endblock #}

<!-- Begin page content -->
    <div class="container">
        <div class="row">
            <div class="col">
                <h4>Survey Entry</h4>
            </div>
            <div class="col-1">
                <button class='btn btn-default pull-right' id='tobottom-button' data-toggle='tooltip' title='Scroll to the bottom'><i class="fa fa-angle-double-down" aria-hidden="true"></i></button>
            </div>
        </div>
        <hr />
            <div class="">
                <form id="selection-form">
                <div class="form-group">
                    <label for="survey_selector">Select survey:</label>
                    <select class="form-control" id="survey_selector">
                        {% for one_item in surveys_list %}
                            <option value="{{ one_item.usid }}">
                            {{ one_item.survey_name }}
                            </option>
                        {% endfor %}
                    </select>
                    <!--label for="team_selector">Select team:</label>
                    <select id="team_selector">
                        {% for one_item in teams_list %}
                            <option value="{{ one_item.tid }}">
                            {{ one_item.team_name }}
                            </option>
                        {% endfor %}
                    </select-->
                    <label for="component_selector">Select component:</label>
                    <select class="form-control" id="component_selector">
                        {% for one_item in components_list %}
                            <option value="{{ one_item.icid }}">
                            {{ one_item.itrack_component_name }}
                            </option>
                        {% endfor %}
                    </select>
                    <label for="version_selector">Select version:</label>
                    <select class="form-control" id="version_selector">
                        {% for one_item in versions_list %}
                            <option value="{{ one_item.icvid }}">
                            {{ one_item.itrack_component_version }}
                            </option>
                        {% endfor %}
                    </select>
                    </div>
                    <!--span class="input-group date" data-date-format="dd.mm.yyyy">
                        <input  type="text" class="form-control" placeholder="dd.mm.yyyy" id="startdate_selector">
                            <div class="input-group-addon" >
                            <span class="glyphicon glyphicon-th"></span>
                        </div>
                    </span>
                    <span class="input-group date" data-date-format="dd.mm.yyyy">
                        <input  type="text" class="form-control" placeholder="dd.mm.yyyy" id="enddate_selector">
                            <div class="input-group-addon" >
                            <span class="glyphicon glyphicon-th"></span>
                        </div>
                    </span-->
                    <!--span>Start date<input type = 'date' id='start_date' name='start_date'></span>
                    <span>End date<input type = 'date' id='end_date' name='end_date'></span-->
                    <input type="button" class='btn btn-primary' value="Search" id="selection-button" method="GET">
                </form>
            </div>
        <hr />
        <form id="sending-form" data-toggle="validator" role="form">
        <div id="results_div" class="row to-print">
            <div id="nodata_div" style="width: 100%; text-align:center;">No data to show!</div>
            <table id="results_tab" class="table" style="display:none;">
                <!--caption>Smaple Data Table</caption-->
                <thead id="tHead"></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
        <hr />
        <div class="row">
            <div id="sending-form-buttons" class="col">
                <input type="button" class='btn btn-primary' value="Send" id="sending-button" method="GET" disabled>
                <input type="button" class='btn btn-primary' value="reset" id="reset-button" disabled>
                <input type="button" class='btn btn-primary' value="Cancel" id="cancel-button" disabled>
            </div>
            <div class="col-1">
                <button class='btn btn-default pull-right' id='totop-button' data-toggle='tooltip' title='Scroll to the top'><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
            </div>
        </div>
        </form>

        <hr />

    </div>

    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
    <script type="text/javascript">

        Date.prototype.toDateInputValue = (function() {
            var local = new Date(this);
            local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
            return local.toJSON().slice(0,10);
        });
        $(document).ready( function() {
            //$('.input-group.date').datepicker({format: "dd.mm.yyyy"});
           // $('#start_date').val(new Date().toDateInputValue());
           // $('#end_date').val(new Date().toDateInputValue());
           //$('#sending-form').validator()
           $('#results_div').data('old-state', $('#results_div').html());

        });
    </script>
    <script type="text/javascript">
        $('#selection-button').click(function(event) {
            event.preventDefault();
            $('#pleaseWaitDialog').modal();
            $('#selection-form :input').prop('disabled', true);
            $('#sending-form :input').prop('disabled', false);
            var survey_selected = $('#survey_selector').find(":selected").val();
            //var team_selected = $('#team_selector').find(":selected").val();
            var component_selected = $('#component_selector').find(":selected").val();
            var version_selected = $('#version_selector').find(":selected").val();
            //var start_date_selected = $('#start_date').val();
            //var end_date_selected = $('#end_date').val();

            $.ajax({
                 url: "{% url 'sur_questions_data' %}",
                 method: 'GET',
                 data : {
                    'filter_survey': parseInt(survey_selected),
                    'filter_component': parseInt(component_selected),
                    'filter_version': parseInt(version_selected)

                 },
                 success: function(data){
                    $('#pleaseWaitDialog').modal('hide');
                    $('#nodata_div').hide();
                    $('#results_tab').show();
                    console.log(data)
                    //$('#figure').html('');
                    chartdata = data.chartdata;
                    question_min_value = data.question_min_value;
                    question_max_value =data.question_max_value;
                    //NumQuestions = chartdata.length;

                    NumDegrees = question_max_value + (-1*question_min_value) + 1;

                    var thHTML = '';
                    thHTML += '<tr align="center"><th>Question</th><th></th>';
                    for (i = 1; i <= NumDegrees; i++) {
                        thHTML += '<th>' + i + '</th>';
                    }

                    thHTML += '<th></th></tr>';

                    $('#tHead').html(thHTML);

                    var trHTML = '';
                    var thDegrees = '';
                    $.each(chartdata, function (j, response) {
                        trHTML += '<tr><td>'
                            + response.Question
                            + '</td><td align="center">'
                            + response.Min_text;

                        thDegrees = '';
                        for (i = 1; i <= NumDegrees; i++) {
                            thDegrees += '</td><td><input type="radio" id="'+response.usqid+'" name="'+response.usqid+'" value="'+i+'">';
                        }
                        thDegrees += '</td><td align="center">';
                        trHTML += thDegrees
                            + response.Max_text
                            + '</td></tr>';
                    });
                    $('#tBody').html(trHTML);
                    //$("form#sending-form input:radio:checked").validator('update')
                 },
                 error: function(xhr, errmsg, err){
                    $('#pleaseWaitDialog').modal('hide');
                    $('#results_div').html($('#results_div').data('old-state'));
                     console.log("error");
                     console.log(errmsg);
                     console.log(err);
                     showToast(2, xhr.responseJSON.error, "toast-top-center");
                 }
            })
        });

        $('#cancel-button').click(function(event) {
            event.preventDefault();
            toastr.clear();
            $('#sending-form-buttons :input').prop('disabled', true);
            $('#selection-form :input').prop('disabled', false);
            $('#results_div').html($('#results_div').data('old-state'));

            //$('#tHead').html('');
            //$('#tBody').html('');
        });

        $('#reset-button').click(function(event) {
            event.preventDefault();
            toastr.clear();
            $("#sending-form :input:radio").each(function() {
                this.checked=false;
            });
        });

        $('#sending-button').click(function(event) {
            event.preventDefault();
            $('#pleaseWaitDialog').modal();
            toastr.clear();
            var blank = false;
            $("input:radio").each(function() {
                var val = $('input:radio[name=' + this.name + ']:checked').val();
                if (val === undefined) {
                    blank = true;
                    return false;
                }
            });
            if (blank) {
               //alert("You missed answering one or more of the questions.");
               //alertFn("You missed answering one or more of the questions!", false)
               showToast(3, "You missed answering one or more of the questions!", "toast-top-center");
               return;
            }
            //alert(blank ? "At least one group is blank" : "All groups are checked");


            var survey_selected = $('#survey_selector').find(":selected").val();
            //var team_selected = $('#team_selector').find(":selected").val();
            var component_selected = $('#component_selector').find(":selected").val();
            var version_selected = $('#version_selector').find(":selected").val();
            //var start_date_selected = $('#start_date').val();
            //var end_date_selected = $('#end_date').val();


            QuestAnswer={};
            checkRadios=$("form#sending-form input:radio:checked");
            for(i=0;i<checkRadios.length;i++) {
                //console.log( index + ": " + $( this ).value + "name: " +$( this ).name);
                QuestAnswer[checkRadios[i].name]=checkRadios[i].value;
            };


            $.ajax({
                 url: "{% url 'sur_entry_data' %}",
                 method: 'GET',
                 data : {
                    'filter_survey': parseInt(survey_selected),
                    'filter_component': parseInt(component_selected),
                    'filter_version': parseInt(version_selected),
                    'questions_answers': JSON.stringify(QuestAnswer)

                 },
                 success: function(data){
                    $('#pleaseWaitDialog').modal('hide');
                    console.log(data)
                    $('#sending-form :input').prop('disabled', true);
                    $('#selection-form :input').prop('disabled', false);
                    $('#results_div').html($('#results_div').data('old-state'));
                    //$('#tHead').html('');
                    //$('#tBody').html('');
                    //alert("Survey completed successfully!");
                    //alertFn("Survey completed successfully!", true)
                    showToast(1, "Survey completed successfully!", "toast-top-center");

                 },
                 error: function(xhr, errmsg, err){
                    $('#pleaseWaitDialog').modal('hide');
                     console.log("error");
                     console.log(errmsg);
                     console.log(err);
                 }
            })
        });



    </script>

{% endblock %}