{% extends "base_generic.html" %}

{% block content %}
{# block title %}SOPs/Policies Show Results{% endblock #}

{% load app_filters %}
{% load static from staticfiles %}

<!-- Begin page content -->
    <link rel="stylesheet" href="http://forio.com/tools/contour/contour.min.css">
    <link rel="stylesheet" href='{% static "css/contour.css" %}'>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js"></script>
    <script src="http://forio.com/tools/contour/contour.min.js"></script>

    <div class="container">
        <div class="row">
            <div class="col">
                <h4 class="to-print">SOPs/Policies Show Results</h4>
            </div>
            <div class="col-1">
                <button class='btn btn-default pull-right' id='tobottom-button' data-toggle='tooltip' title='Scroll to the bottom'><i class="fa fa-angle-double-down" aria-hidden="true"></i></button>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col">
                <form id="selection-form">
                    <div class="form-group">
                        <label for="missions_selector">Select mission(s):</label>
                        <select class="form-control" id="missions_selector" multiple="multiple">
                            {% for one_item in missions_list %}
                                <option value="{{ one_item.mid }}" {% if forloop.first %}{{ 'selected="selected"' }}{% endif %}>
                                {{ one_item.mission_name }}
                                </option>
                            {% endfor %}
                        </select>

                        <!--label for="country_selector">Select country:</label>
                        <select class="form-control" id="country_selector">
                            {% for key, value in keys_country.items %}
                                <option value="{{ key }}">
                                {{ value }}
                                </option>
                            {% endfor %}
                        </select>
                        <label for="location_selector">Select location:</label>
                        <select class="form-control" id="location_selector">
                            {% for key, value in keys_location.items %}
                                <option value="{{ key }}">
                                {{ value }}
                                </option>
                            {% endfor %}
                        </select>
                        <label for="attack_context_selector">Select attack context:</label>
                        <select class="form-control" id="attack_context_selector">
                            {% for key, value in keys_attack_context.items %}
                                <option value="{{ key }}">
                                {{ value }}
                                </option>
                            {% endfor %}
                        </select>
                        <label for="means_of_attack_selector">Select means of attack:</label>
                        <select class="form-control" id="means_of_attack_selector">
                            {% for key, value in keys_means_of_attack.items %}
                                <option value="{{ key }}">
                                {{ value }}
                                </option>
                            {% endfor %}
                        </select-->


                        <!--select id="team_selector">
                            {% for one_item in teams_list %}
                                <option value="{{ one_item.tid }}">
                                {{ one_item.team_name }}
                                </option>
                            {% endfor %}
                        </select-->
                    </div>
                    <input class='btn btn-primary' type="button" value="Search" id="selection-button" method="GET">
                </form>
            </div>
        </div>
        <hr />
        <div id="results_div" class="row to-print">
            <div class="col">
                <div id="nodata_div" style="width: 100%; text-align:center;">No data to show!</div>
                <div id="comment_div_0" class="" style="width: 100%"></div>
                {% for key, value in keys_sop_policies_tag.items %}
                <div class="" style="width: 100%;">
                    <div>
                        <div style="float:right; width: 60%">
                            <div style="width: 80%; margin: auto;"><div id="legend_div_{{ key }}" style="position: relative"></div></div>
                            <div style="width: 100%; margin: auto;"><div id="figure_{{ key }}"></div></div>
                        </div>
                        <span id="comment_div_{{ key }}"></span>
                    </div>
                </div>
                {% if forloop.last %}{% else %}{{ '<hr class="hiddenhr" style="display: none;" />' }}{% endif %}
                {% endfor %}
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col">
                <input type="button" class='btn btn-primary' value="Print" onclick="window.print();" id="print-button">
            </div>
            <div class="col-1">
                <button class='btn btn-default pull-right' id='totop-button' data-toggle='tooltip' title='Scroll to the top'><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
            </div>
        </div>

        <hr />

    </div>

    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
    <script type="text/javascript">
        var formatter = function (v, fmt) {
            var format = fmt || 's';
            if (v < 10 && /s$/.test(format)) {
                format = '.1f';
            }

            return d3.format(format)(v).replace('G', 'B');
        };

        var safeParse = function (value, defaultValue) {
            var val = +value;
            return val === val ? val : defaultValue;
        };

        //fig_size=0.6*$(document).width();
        //fig_size=0.6*$('.container').width()

        //https://stackoverflow.com/questions/6982692/html5-input-type-date-default-value-to-today/30788475
        Date.prototype.toDateInputValue = (function(d) {
            var local = new Date(this);
            local.setMinutes(this.getMinutes() - this.getTimezoneOffset()-d*365.25*24*60);
            return local.toJSON().slice(0,10);
        });


        $(document).ready( function() {
            // Do this on $(document).ready(function() { ... })
            $('#results_div').data('old-state', $('#results_div').html());

            //$('.input-group.date').datepicker({format: "dd.mm.yyyy"});
            $('#start_date').val(new Date().toDateInputValue(1));
            $('#end_date').val(new Date().toDateInputValue(0));
        });

        $( "#selection-button" ).click(function(event) {
            event.preventDefault();

            {% for key, value in keys_sop_policies_tag.items %}
            if (typeof fig_{{ key }}!= "undefined") {
                delete fig_{{ key }}
            }
            {% endfor %}
            // Restore element with a copy of divClone
            $('#results_div').html($('#results_div').data('old-state'));

            $('#pleaseWaitDialog').modal();
            //var team_selected = $('#team_selector').find(":selected").val();

            //var mission_selected = $('#mission_selector').find(":selected").val();
            var missions_selected = $('#missions_selector').val();
            var country_selected = $('#country_selector').find(":selected").val();
            var location_selected = $('#location_selector').find(":selected").val();
            var attack_context_selected = $('#attack_context_selector').find(":selected").val();
            var means_of_attack_selected = $('#means_of_attack_selector').find(":selected").val();

            //var start_date_selected = $('#start_date').val();
            //var end_date_selected = $('#end_date').val();

            $.ajax({
                 url: "{% url 'sop_show_data' %}",
                 method: 'GET',
                 data : {
                    /*'filter_mission': parseInt(mission_selected),*/
                    'filter_missions': String(missions_selected),
                    'filter_country': country_selected,
                    'filter_location': location_selected,
                    'filter_attack_context': attack_context_selected,
                    'filter_means_of_attack': means_of_attack_selected

                 },
                 success: function(data){
                    $('#pleaseWaitDialog').modal('hide');
                    console.log(data)
                    // to access data for charts from data.sop_ind_vals[1] to data.sop_ind_vals[13], the number is the Tag data.sop_ind_vals[Tag]
                    //Chart
                    //fig_{{ key }}
                    //comment_div_{{ key }}
                    //$('#figure').html('');
                    //data['sop_ind_txt'][tag]

                    $('#nodata_div').remove();

                    $('#comment_div_0').html(data['general_comment']);

                    for (Tag in data['sop_ind_txt']) {
                        $('#comment_div_'+Tag).html(data['sop_ind_txt'][Tag]);
                    }

                    $('.hiddenhr').show();


                    {% for key, value in keys_sop_policies_tag.items %}
                    var fig_{{ key }} = new Contour({
                            el: document.getElementById("figure_{{ key }}"),
                        chart: {
                            //defaultWidth: 800,
                            //width: 800,
                            width: 0.6*$('.container').width(),
                            padding: {
                                left: 50,
                                right: 50
                            }
                        },
                        xAxis: {
                            title: 'Date',
                            type: 'linear',
                            maxTicks: 3
                        },
                        yAxis: {
                            title: '{{ value }} Indicator',
                            /*min: 0,*/
                            /*ticks: safeParse(this.yTicks, undefined),*/
                            smartAxis: true,
                            labels: {
                                formatter: function (v) {
                                    return formatter(v, ".3s");
                                }
                            }
                        },
                        legend: {
                            el: document.getElementById("legend_div_{{ key }}"),
                            direction: 'horizontal',
                            hAlign: 'right',
                            vAlign: 'top'
                        }
                    }).cartesian().scatter().legend().tooltip().trendLine();

                    // data.sop_ind_vals[{{ key }}] = [{"name":"ss03","data":[{"x":"2018-04-01 23:48","y":2},{"x":"2018-05-05 16:28","y":2}]}]
                    for (i in data.sop_ind_vals[{{ key }}]){
                        // data.sop_ind_vals[{{ key }}][i] = {name: "ss03", data: Array(4)}
                        for (j in data.sop_ind_vals[{{ key }}][i].data){
                            console.log(data.sop_ind_vals[{{ key }}][i].data[j].x);
                            data.sop_ind_vals[{{ key }}][i].data[j].x = new Date(data.sop_ind_vals[{{ key }}][i].data[j].x);
                            data.sop_ind_vals[{{ key }}][i].data[j].y = parseFloat(data.sop_ind_vals[{{ key }}][i].data[j].y);
                        }
                        data.sop_ind_vals[{{ key }}][i].data.sort(function(a, b){
                            return a.x - b.x;
                        })
                    }
                    fig_{{ key }}.setData(data.sop_ind_vals[{{ key }}]).render();
                    $('#legend_div_{{ key }}').css({'position':'relative','top':'0px', 'right':'0px'});
                    {% endfor %}


                 },
                 error: function(xhr, errmsg, err){
                     $('#pleaseWaitDialog').modal('hide');
                     console.log("error");
                     console.log(errmsg);
                     console.log(err);
                     //data=[];
                     //data=[{"name":"","data":[{"x":new Date("2000-01-01T00:00:00.000Z"),"y":""}]}];
                     /*data=[{"name":"","data":[{"x":new Date(Date.now()),"y":""}]}];*/
                 }
            })
        });



    </script>

{% endblock %}